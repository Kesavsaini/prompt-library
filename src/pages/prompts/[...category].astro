---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import PromptCard from "../../components/PromptCard.astro";
import PromptGroup from "../../components/PromptGroup.astro";
import { toTitleCase } from "@/lib/utils";



export async function getStaticPaths() {
	const prompts = await getCollection("prompts");
	const paths = new Set<string>();

	prompts.forEach((p) => {
		const segments = p.id.split("/");
		segments.pop(); // Remove filename
		let currentPath = "";
		segments.forEach((segment) => {
			currentPath = currentPath ? `${currentPath}/${segment}` : segment;
			paths.add(currentPath);
		});
	});

	return Array.from(paths).map((category) => {
		const categoryPath = category + "/";
		const filteredPrompts = prompts.filter((p) =>
			p.id.startsWith(categoryPath),
		);
		return {
			params: { category },
			props: {
				category: toTitleCase(category),
				prompts: filteredPrompts,
			},
		};
	});
}

const { category, prompts } = Astro.props;

// Sort by date descending
prompts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group by subcategory
const subcategories: Record<string, typeof prompts> = {};
const rootPrompts: typeof prompts = [];

prompts.forEach((p) => {
	// Remove the current category path prefix from id
	// e.g. category="coding", id="coding/react/hooks.mdx" -> relative="react/hooks.mdx"
	const relativePath = p.id.startsWith(category.toLowerCase() + "/")
		? p.id.slice(category.length + 1)
		: p.id;

	const parts = relativePath.split("/");
	if (parts.length > 1) {
		const subcat = parts[0];
		if (!subcategories[subcat]) {
			subcategories[subcat] = [];
		}
		subcategories[subcat].push(p);
	} else {
		rootPrompts.push(p);
	}
});

const hasSubcategories = Object.keys(subcategories).length > 0;
---

<Layout
	title={`${category} Prompts`}
	description={`Browse our collection of ${category} prompts.`}
>
	<div class="mb-12 text-center">
		<h1 class="text-4xl md:text-5xl font-bold mb-4">{category} Prompts</h1>
		<p class="text-xl text-slate-400 max-w-2xl mx-auto">
			Browse our curated selection of prompts for {category}.
		</p>
	</div>

	<div class="space-y-12">
		{
			hasSubcategories ? (
				<>
					{Object.entries(subcategories).map(
						([subcat, subPrompts]) => (
							<PromptGroup
								title={toTitleCase(subcat)}
								href={`/prompt-library/prompts/${category.toLowerCase()}/${subcat}`}
								prompts={subPrompts}
							/>
						),
					)}
					{rootPrompts.length > 0 && (
						<PromptGroup title="Other" prompts={rootPrompts} />
					)}
				</>
			) : (
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
					{prompts.map((prompt) => (
						<PromptCard prompt={prompt} />
					))}
				</div>
			)
		}
	</div>
</Layout>
