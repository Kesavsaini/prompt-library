---
// ------------------------------------------------------------------
// ASTRO IMPORTS
// ------------------------------------------------------------------
import { getCollection, render } from "astro:content";
// NOTE: Assuming your root Layout is in the structure:
// import Layout from "../../layouts/Layout.astro";
import Layout from "../../layouts/Layout.astro";

// ------------------------------------------------------------------
// UI & UTILITY IMPORTS (Standardizing to @/components/ui/...)
// ------------------------------------------------------------------
// NOTE: Update these paths if your PromptCard/PromptGroup are NOT in the UI folder
import PromptCard from "../../components/PromptCard.astro";
import PromptGroup from "../../components/PromptGroup.astro";

import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button"; // NEW: For back button
import {
	Card,
	CardContent,
	CardHeader,
	CardTitle,
	CardDescription,
} from "@/components/ui/card"; // NEW: For prompt content
import { cn, toTitleCase } from "../../lib/utils"; // Assuming utils contains cn and toTitleCase
import { CopyButton } from "@/components/CopyButton";

// ------------------------------------------------------------------
// DATA FETCHING & PATH GENERATION
// ------------------------------------------------------------------
export async function getStaticPaths() {
	const prompts = await getCollection("prompts");
	const paths = [];

	// 1. Prompt Paths
	prompts.forEach((p) => {
		paths.push({
			params: { slug: p.id },
			props: { type: "prompt", data: p },
		});
	});

	// 2. Category Paths
	const categories = new Set<string>();
	prompts.forEach((p) => {
		const segments = p.id.split("/");
		segments.pop(); // remove file name
		let currentPath = "";
		segments.forEach((segment) => {
			currentPath = currentPath ? `${currentPath}/${segment}` : segment;
			categories.add(currentPath);
		});
	});

	categories.forEach((cat) => {
		const catPath = cat + "/";
		// Filter prompts that belong to this category (including subcategories)
		const catPrompts = prompts.filter((p) => p.id.startsWith(catPath));

		paths.push({
			params: { slug: cat },
			props: {
				type: "category",
				data: { category: cat, prompts: catPrompts },
			},
		});
	});

	return paths;
}

const { type, data } = Astro.props;
let Content;
if (type === "prompt") {
	// Render the prompt content markdown
	const rendered = await render(data);
	Content = rendered.Content;
}

// ------------------------------------------------------------------
// CATEGORY INDEX PAGE LOGIC
// ------------------------------------------------------------------
let subcategories: Record<string, typeof data.prompts> = {};
let rootPrompts: typeof data.prompts = [];
let hasSubcategories = false;

if (type === "category") {
	const { category, prompts } = data;
	// Sort by most recent first
	prompts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

	prompts.forEach((p) => {
		const relativePath = p.id.startsWith(category.toLowerCase() + "/")
			? p.id.slice(category.length + 1)
			: p.id;

		const parts = relativePath.split("/");
		if (parts.length > 1) {
			// It's a subcategory
			const subcat = parts[0];
			if (!subcategories[subcat]) {
				subcategories[subcat] = [];
			}
			subcategories[subcat].push(p);
		} else {
			// It's a root prompt in this category
			rootPrompts.push(p);
		}
	});
	hasSubcategories = Object.keys(subcategories).length > 0;
}
---

{
	type === "prompt" ? (
		<Layout title={data.data.title} description={data.data.description}>
			<div class="w-full px-4 sm:px-6 lg:px-8 py-10">
				{/* Back Button (Using Shadcn Button) */}
				<Button
					as="a"
					href="/prompt-library/prompts"
					variant="link"
					class="mb-8 p-0 h-auto text-muted-foreground hover:text-primary"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-4 w-4 mr-2"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
						stroke-width="2"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							d="M10 19l-7-7m0 0l7-7m-7 7h18"
						/>
					</svg>
					Back to Prompts
				</Button>

				<article class="max-w-3xl mx-auto">
					{/* Header Section (Using Card components for structure) */}
					<Card className="mb-12 border-0 shadow-none bg-transparent text-center">
						<CardHeader>
							<div className="flex justify-center mb-4">
								{/* Category Badge */}
								<Badge variant="default" className="text-xs">
									{toTitleCase(data.data.category)}
								</Badge>
							</div>
							{/* Title and Description */}
							<CardTitle className="text-4xl md:text-5xl lg:text-6xl font-extrabold mb-4">
								{data.data.title}
							</CardTitle>
							<CardDescription className="text-lg md:text-xl max-w-3xl mx-auto">
								{data.data.description}
							</CardDescription>
						</CardHeader>
						<CardContent className="pt-4">
							{/* Tags */}
							<div class="flex flex-wrap justify-center gap-2">
								{data.data.tags.map((tag) => (
									<Badge
										variant="outline"
										className="text-xs"
									>
										#{tag}
									</Badge>
								))}
							</div>
						</CardContent>
					</Card>

					{/* Content Section (Wrapped in Card for structure) */}
					<Card className="rounded-2xl relative bg-background">
						<div class="absolute top-4 right-4 z-10">
							<CopyButton
								value={data.body}
								client:load
								className="bg-muted hover:bg-background"
							/>
						</div>
						<CardContent className="p-8 md:p-12 prose prose-invert prose-lg max-w-none prose-pre:bg-secondary prose-pre:text-secondary-foreground prose-pre:border prose-pre:border-border">
							<Content />
						</CardContent>
					</Card>
				</article>
			</div>
		</Layout>
	) : (
		<Layout
			title={`${toTitleCase(data.category)} Prompts`}
			description={`Browse our collection of ${data.category} prompts.`}
		>
			<div class="mb-16 text-center max-w-4xl mx-auto px-4 sm:px-6">
				<h1 class="text-4xl md:text-5xl font-bold mb-4">
					{toTitleCase(data.category)} Prompts
				</h1>
				<p class="text-xl text-muted-foreground">
					Browse our curated selection of prompts for{" "}
					{toTitleCase(data.category)}.
				</p>
			</div>

			<div class="space-y-12 max-w-6xl mx-auto px-4 sm:px-6">
				{/* 1. Category with Subgroups */}
				{hasSubcategories ? (
					<>
						{Object.entries(subcategories).map(
							([subcat, subPrompts]) => (
								<PromptGroup
									title={toTitleCase(subcat)}
									href={`/prompt-library/prompts/${data.category.toLowerCase()}/${subcat}`}
									prompts={subPrompts as any[]}
								/>
							),
						)}
						{rootPrompts.length > 0 && (
							<PromptGroup
								title="Other Prompts in This Category"
								prompts={rootPrompts as any[]}
							/>
						)}
					</>
				) : (
					/* 2. Flat Category (No Subgroups) */
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
						{data.prompts.map((prompt) => (
							<PromptCard prompt={prompt} />
						))}
					</div>
				)}
			</div>
		</Layout>
	)
}
