name: Process Prompt Submission

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-prompt:
    # Trigger if label exists OR title starts with [New Prompt] (backup for missing labels)
    if: contains(github.event.issue.labels.*.name, 'prompt-submission') || startsWith(github.event.issue.title, '[New Prompt]:')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Parse Issue Form
        id: issue-parser
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            
            // Helper to extract value between headers
            function extractValue(header) {
              const regex = new RegExp(`### ${header}\\s+([\\s\\S]*?)(?=(?:###|$))`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }
            
            const title = extractValue('Prompt Title');
            const description = extractValue('Description');
            let category = extractValue('Category');
            let subcategory = extractValue('Subcategory \\(Optional\\)');
            const tags = extractValue('Tags');
            const content = extractValue('Prompt Content');
            
            // Handle Empty Inputs (GitHub Issue Forms use '_No response_' for empty fields)
            if (subcategory === '_No response_') subcategory = '';
            
            // Capitalize Category to match z.enum(['Coding', 'Writing', 'Productivity', 'Other'])
            // The template uses lowercase keys, so we map them.
            const categoryName = category.charAt(0).toUpperCase() + category.slice(1).toLowerCase();
            const categorySlug = category.toLowerCase();

            // Output variables
            core.setOutput('title', title);
            core.setOutput('description', description);
            core.setOutput('category_name', categoryName);
            core.setOutput('category_slug', categorySlug);
            core.setOutput('subcategory', subcategory ? subcategory.toLowerCase() : '');
            core.setOutput('tags', tags);
            core.setOutput('content', content);

      - name: Generate File Path and Content
        id: generate
        run: |
          TITLE="${{ steps.issue-parser.outputs.title }}"
          DESC="${{ steps.issue-parser.outputs.description }}"
          CAT_NAME="${{ steps.issue-parser.outputs.category_name }}"
          CAT_SLUG="${{ steps.issue-parser.outputs.category_slug }}"
          SUBCAT="${{ steps.issue-parser.outputs.subcategory }}"
          TAGS="${{ steps.issue-parser.outputs.tags }}"
          CONTENT="${{ steps.issue-parser.outputs.content }}"
          
          # Slugify title
          SLUG=$(echo "$TITLE" | iconv -t ascii//TRANSLIT | sed -r s/[^a-zA-Z0-9]+/-/g | sed -r s/^-+\|-+$//g | tr A-Z a-z)
          
          # Construct Path
          if [ -z "$SUBCAT" ]; then
             DIR="src/content/prompts/$CAT_SLUG"
          else
             DIR="src/content/prompts/$CAT_SLUG/$SUBCAT"
          fi
          
          FILENAME="$DIR/$SLUG.mdx"
          
          echo "Creating directory: $DIR"
          mkdir -p "$DIR"
          
          # Create file content
          # We need to handle multi-line content carefully for the EOF
          
          cat <<EOF > "$FILENAME"
          ---
          title: '$TITLE'
          description: '$DESC'
          pubDate: $(date +%Y-%m-%d)
          category: '$CAT_NAME'
          tags: [$(echo $TAGS | sed "s/,/','/g" | sed "s/^/'/" | sed "s/$/'/")]
          ---

          $CONTENT
          EOF
          
          echo "Created $FILENAME"
          cat "$FILENAME"
          
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: add NEW prompt '$SLUG'"
          title: "feat: add prompt ${{ steps.issue-parser.outputs.title }}"
          body: |
            This PR adds the prompt "${{ steps.issue-parser.outputs.title }}" submitted via Issue #${{ github.event.issue.number }}.
            
            Closes #${{ github.event.issue.number }}
          branch: "prompt/issue-${{ github.event.issue.number }}"
          base: main
